%h1 Life Expectancy
%p
  People are living longer around the world, some more so than others. Select a region (as defined by World Bank) below to compare, or roll over to the graph to highlight countries.
  %a{:href => "http://flowingdata.com/2011/10/13/life-expectancy-changes/"} Read more...
#filters
  %a#EAS East Asia and Pacific
  %a#SAS South Asia
  %a#ECS Europe and Central Asia
  %a#MEA Middle East and North Africa
  %a#SSF Sub-Saharan Africa
  %a#LCN Latin America and Caribbean
  %a#NAC North America
#blurb
  #default-blurb
    %h2 World
    %p The average life expectancy in the world in 2009 was 69 years.
  #blurb-content
#vis
:javascript
  $(document).ready(function() {
    $('#filters a').click(function() {
        var countryId = $(this).attr("id");
        $(this).toggleClass(countryId);
        showRegion(countryId);
    });
  });

  var regions={"SAS":"South Asia","ECS":"Europe and Central Asia","MEA":"Middle East & North Africa","SSF":"Sub-Saharan Africa","LCN":"Latin America & Caribbean","EAS":"East Asia & Pacific","NAC":"North America"},
    w=925,
    h=550,
    margin=30,
    startYear=1960,
    endYear=2010,
    startAge=20,
    endAge=80,
    y=d3.scaleLinear().domain([endAge,startAge]).range([0+ margin,h- margin]),
    x=d3.scaleLinear().domain([1960,2009]).range([0+ margin-5,w]),
    years=d3.range(startYear,endYear);
  var vis=d3.select("#vis").append("svg:svg").attr("width",w).attr("height",h).append("svg:g")
  var line=d3.line().x(function(d,i){return x(d.x);}).y(function(d){return y(d.y);});
  var countries_regions={};
  var startEnd={}, countryCodes={};

  d3.json('#{data_file_link('/visualizations/life_expectancy_multi_line_chart.json')}', function(data){
    for(i=1;i<data.length;i++){
      var d = data[i]
      countries_regions[d[1]]=d[2];

      var values=d.slice(4, d.length-1);
      var currData=[];
      countryCodes[d[1]]=d[0];
      var started=false;
      for(j=0; j<values.length; j++){
        if(values[j]!=''){
          currData.push({x:years[j],y:values[j]});
          if(!started){
            startEnd[d[1]]={'startYear':years[j],'startVal':values[j]};started=true;
          } else if(j==values.length-1){
            startEnd[d[1]]['endYear']=years[j];
            startEnd[d[1]]['endVal']=values[j];
          }
        }
      }
      vis.append("svg:path")
        .data([currData])
        .attr("country",d[1])
        .attr("class",d[2])
        .attr("d",line)
        .on("mouseover",onmouseover)
        .on("mouseout",onmouseout);
    }


      vis.append("svg:line")
        .attr("x1",x(1960))
        .attr("y1",y(startAge))
        .attr("x2",x(2009))
        .attr("y2",y(startAge))
        .attr("class","axis")
      vis.append("svg:line")
        .attr("x1",x(startYear))
        .attr("y1",y(startAge))
        .attr("x2",x(startYear))
        .attr("y2",y(endAge))
        .attr("class","axis")
      vis.selectAll(".xLabel")
        .data(x.ticks(5))
        .enter()
        .append("svg:text")
        .attr("class","xLabel")
        .text(String)
        .attr("x",function(d){return x(d)})
        .attr("y",h-10)
        .attr("text-anchor","middle")
      vis.selectAll(".yLabel")
        .data(y.ticks(4))
        .enter()
        .append("svg:text")
        .attr("class","yLabel")
        .text(String)
        .attr("x",0)
        .attr("y",function(d){return y(d)})
        .attr("text-anchor","right")
        .attr("dy",3)
      vis.selectAll(".xTicks")
        .data(x.ticks(5))
        .enter()
        .append("svg:line")
        .attr("class","xTicks")
        .attr("x1",function(d){return x(d);})
        .attr("y1",y(startAge))
        .attr("x2",function(d){return x(d);})
        .attr("y2",y(startAge)+7)
      vis.selectAll(".yTicks")
        .data(y.ticks(4))
        .enter()
        .append("svg:line")
        .attr("class","yTicks")
        .attr("y1",function(d){return y(d);})
        .attr("x1",x(1959.5))
        .attr("y2",function(d){return y(d);})
        .attr("x2",x(1960))
    });

  function onclick(d,i){
    var currClass=d3.select(this).attr("class");
    if(d3.select(this).classed('selected')){
      d3.select(this).attr("class",currClass.substring(0,currClass.length-9));
    } else {
      d3.select(this).classed('selected',true);
    }
  }
  function onmouseover(d,i){
    var currClass=d3.select(this).attr("class");
    d3.select(this).attr("class",currClass+" current");
    var countryCode=$(this).attr("country");
    var countryVals=startEnd[countryCode];
    var percentChange=100*(countryVals['endVal']- countryVals['startVal'])/ countryVals['startVal'];
    var blurb='<h2>'+ countryCodes[countryCode]+'</h2>';
    blurb+="<p>On average: a life expectancy of "+ Math.round(countryVals['startVal'])+" years in "+ countryVals['startYear']+" and "+ Math.round(countryVals['endVal'])+" years in "+ countryVals['endYear']+", ";
    if(percentChange>=0){
      blurb+="an increase of "+ Math.round(percentChange)+" percent."
    } else {
      blurb+="a decrease of "+-1*Math.round(percentChange)+" percent."
    }
    blurb+="</p>";
    $("#default-blurb").hide();
    $("#blurb-content").html(blurb);
  }
  function onmouseout(d,i){
    var currClass=d3.select(this).attr("class");
    var prevClass=currClass.substring(0,currClass.length-8);
    d3.select(this).attr("class",prevClass);
    $("#default-blurb").show();
    $("#blurb-content").html('');
  }
  function showRegion(regionCode){
    var countries=d3.selectAll("path."+regionCode);
    if(countries.classed('highlight')){
      countries.attr("class",regionCode);
    } else {
      countries.classed('highlight',true);
    }
  }
